#!/bin/bash
# =============================================================================
# PF-CORE Droplet Bootstrap Script (Docker)
# =============================================================================
# Generated by PF-CORE CI/CD Agent
# Instance: {{ instance_id }}
# Environment: {{ environment }}
# =============================================================================
set -e

echo "=========================================="
echo "  PF-CORE Droplet Setup (Docker)"
echo "  Instance: {{ instance_id }}"
echo "  Environment: {{ environment }}"
echo "=========================================="

# -----------------------------------------------------------------------------
# System Updates
# -----------------------------------------------------------------------------
echo ">>> Updating system packages..."
apt-get update && apt-get upgrade -y

# -----------------------------------------------------------------------------
# Install Docker
# -----------------------------------------------------------------------------
echo ">>> Installing Docker..."
apt-get install -y ca-certificates curl gnupg lsb-release
mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
apt-get update
apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# Enable Docker service
systemctl enable docker
systemctl start docker

# -----------------------------------------------------------------------------
# Install Node.js (for PM2)
# -----------------------------------------------------------------------------
echo ">>> Installing Node.js..."
curl -fsSL https://deb.nodesource.com/setup_{{ node_version | default("20") }}.x | bash -
apt-get install -y nodejs

# Install PM2
npm install -g pm2

# -----------------------------------------------------------------------------
# Install Nginx
# -----------------------------------------------------------------------------
echo ">>> Installing Nginx..."
apt-get install -y nginx

# -----------------------------------------------------------------------------
# Install Certbot for SSL
# -----------------------------------------------------------------------------
echo ">>> Installing Certbot..."
apt-get install -y certbot python3-certbot-nginx

# -----------------------------------------------------------------------------
# Configure Firewall
# -----------------------------------------------------------------------------
echo ">>> Configuring firewall..."
apt-get install -y ufw fail2ban

ufw default deny incoming
ufw default allow outgoing
ufw allow ssh
ufw allow http
ufw allow https
ufw --force enable

# Configure fail2ban
systemctl enable fail2ban
systemctl start fail2ban

# -----------------------------------------------------------------------------
# Create Application Structure
# -----------------------------------------------------------------------------
echo ">>> Creating application structure..."
mkdir -p /app/{current,releases,shared}
mkdir -p /app/shared/logs

# -----------------------------------------------------------------------------
# Create Deploy User
# -----------------------------------------------------------------------------
echo ">>> Creating deploy user..."
if ! id -u deploy &>/dev/null; then
    useradd -m -s /bin/bash deploy
    usermod -aG sudo deploy
    usermod -aG docker deploy
fi
chown -R deploy:deploy /app

# -----------------------------------------------------------------------------
# Setup PM2 Startup
# -----------------------------------------------------------------------------
echo ">>> Configuring PM2 startup..."
pm2 startup systemd -u deploy --hp /home/deploy
env PATH=$PATH:/usr/bin pm2 startup systemd -u deploy --hp /home/deploy

# -----------------------------------------------------------------------------
# Create docker-compose.yml
# -----------------------------------------------------------------------------
echo ">>> Creating docker-compose configuration..."
cat > /app/docker-compose.yml << 'DOCKER_EOF'
version: '3.8'

services:
  app:
    image: ghcr.io/{{ github_org }}/{{ repo_name }}:{{ environment }}
    container_name: {{ instance_id }}-{{ product_id }}-app
    restart: unless-stopped
    ports:
      - "127.0.0.1:3000:3000"
    env_file:
      - /app/shared/.env
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  default:
    name: pf-core-network
DOCKER_EOF

# -----------------------------------------------------------------------------
# Create PM2 Ecosystem Config
# -----------------------------------------------------------------------------
echo ">>> Creating PM2 ecosystem config..."
cat > /app/shared/ecosystem.config.js << 'PM2_EOF'
module.exports = {
  apps: [{
    name: '{{ instance_id }}-{{ product_id }}',
    script: 'server.js',
    cwd: '/app/current',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    env_file: '/app/shared/.env',

    // Logging
    log_file: '/app/shared/logs/combined.log',
    error_file: '/app/shared/logs/error.log',
    out_file: '/app/shared/logs/out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',

    // Restart policy
    max_restarts: 10,
    min_uptime: '10s',
    max_memory_restart: '500M',

    // Graceful reload
    kill_timeout: 5000,
    wait_ready: true,
    listen_timeout: 10000
  }]
};
PM2_EOF

chown deploy:deploy /app/shared/ecosystem.config.js

# -----------------------------------------------------------------------------
# Create Environment Template
# -----------------------------------------------------------------------------
echo ">>> Creating environment template..."
cat > /app/shared/.env.example << 'ENV_EOF'
# Application
NODE_ENV=production
PORT=3000

# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# Application URL
NEXT_PUBLIC_APP_URL=https://{{ domain }}
ENV_EOF

echo "=========================================="
echo "  Bootstrap Complete!"
echo "=========================================="
echo ""
echo "Next steps:"
echo "1. Copy /app/shared/.env.example to /app/shared/.env and configure"
echo "2. Configure Nginx: certbot --nginx -d {{ domain }}"
echo "3. Login to GHCR: echo \$TOKEN | docker login ghcr.io -u USERNAME --password-stdin"
echo "4. Deploy application"
