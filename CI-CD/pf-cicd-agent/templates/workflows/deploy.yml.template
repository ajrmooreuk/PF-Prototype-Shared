# =============================================================================
# {{ product_name }} Deployment Pipeline
# =============================================================================
# Generated by PF-CORE CI/CD Agent
# Instance: {{ instance_id }}
# Product: {{ product_id }}
# Environment: {{ environment }}
# =============================================================================

name: "Deploy to {{ environment | title }}"

on:
{% if environment == "development" %}
  push:
    branches: [develop]
{% elif environment == "staging" %}
  push:
    branches: ['release/*']
{% else %}
  release:
    types: [published]
{% endif %}
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to deploy'
        required: false
        default: ''

env:
  NODE_VERSION: '{{ node_version | default("20") }}'
  ENVIRONMENT: '{{ environment }}'

concurrency:
  group: deploy-{{ environment }}
  cancel-in-progress: false

jobs:
  # ===========================================================================
  # Deploy
  # ===========================================================================
  deploy:
    name: Deploy to {{ environment | title }}
    runs-on: ubuntu-latest
    environment:
      name: {{ environment }}
      url: https://{{ domain }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: {% raw %}${{ github.event.inputs.ref || github.ref }}{% endraw %}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: {% raw %}${{ env.NODE_VERSION }}{% endraw %}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Application
        run: npm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1
{% if environment == "production" %}
          NEXT_PUBLIC_SUPABASE_URL: {% raw %}${{ secrets.SUPABASE_URL }}{% endraw %}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: {% raw %}${{ secrets.SUPABASE_ANON_KEY }}{% endraw %}
{% endif %}

      - name: Prepare Deployment
        run: |
          mkdir -p deploy-package
          cp -r .next/standalone/* deploy-package/
          cp -r .next/static deploy-package/.next/
          cp -r public deploy-package/ 2>/dev/null || true
          cp package.json deploy-package/

      - name: Deploy to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: {% raw %}${{ secrets.{% endraw %}{{ environment | upper }}_HOST{% raw %} }}{% endraw %}
          username: {% raw %}${{ secrets.{% endraw %}{{ environment | upper }}_USER{% raw %} }}{% endraw %}
          key: {% raw %}${{ secrets.{% endraw %}{{ environment | upper }}_SSH_KEY{% raw %} }}{% endraw %}
          source: "deploy-package/*"
          target: "/app/releases/{% raw %}${{ github.sha }}{% endraw %}"
          strip_components: 1

      - name: Activate Release
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: {% raw %}${{ secrets.{% endraw %}{{ environment | upper }}_HOST{% raw %} }}{% endraw %}
          username: {% raw %}${{ secrets.{% endraw %}{{ environment | upper }}_USER{% raw %} }}{% endraw %}
          key: {% raw %}${{ secrets.{% endraw %}{{ environment | upper }}_SSH_KEY{% raw %} }}{% endraw %}
          script: |
            # Symlink new release
            ln -sfn /app/releases/{% raw %}${{ github.sha }}{% endraw %} /app/current

            # Copy environment variables
            cp /app/shared/.env /app/current/.env

            # Reload application (zero-downtime)
            cd /app/current
            pm2 reload ecosystem.config.js --env production || pm2 start ecosystem.config.js --env production

            # Cleanup old releases (keep last 5)
            cd /app/releases && ls -t | tail -n +6 | xargs -r rm -rf

            echo "✅ {{ environment | title }} deployment complete!"

{% if environment == "staging" %}
      - name: Run E2E Tests
        run: |
          npm run test:e2e:critical
        env:
          BASE_URL: https://{{ domain }}
{% endif %}

      - name: Health Check
        run: |
          sleep 10
          curl --retry 5 --retry-delay 5 --fail https://{{ domain }}/api/health
          echo "✅ Health check passed!"
